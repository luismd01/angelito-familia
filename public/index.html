<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Angelito Familiar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS (from CDN, free) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-christmas">

  <div class="overlay"></div>

  <div class="container d-flex flex-column justify-content-center align-items-center min-vh-100">
    <div class="card main-card shadow-lg">
      <div class="card-body text-center">
        <h1 class="mb-3 text-white fw-bold">
           Angelito Familiar Maldonado
        </h1>
        <p class="text-light mb-4">
          Escribe el c贸digo que recibiste para descubrir qui茅n es tu angelito.
        </p>

        <form id="codeForm" class="mb-3">
          <div class="mb-3">
            <input
              type="text"
              id="codeInput"
              class="form-control form-control-lg text-center"
              placeholder="Escribe tu c贸digo aqu铆"
              required
            />
          </div>
          <button type="submit" class="btn btn-success btn-lg w-100 fw-bold">
            Descubrir mi angelito 
          </button>
        </form>

        <div id="message" class="mt-3"></div>

        <div id="celebration" class="celebration d-none mt-4">
          <h2 class="text-warning fw-bold mb-3" id="celebrationTitle"></h2>
          <p class="text-white fs-5">
            Guarda este nombre en secreto  y prep谩rate para sorprender.
          </p>
        </div>
      </div>
    </div>

    <p class="small text-light mt-4 opacity-75">
      Proyecto familiar 路 Hecho con  y 
    </p>
  </div>

  <!-- Bootstrap JS (optional, for some helpers) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- LGICA + FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAnalytics,
      isSupported
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      where,
      doc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 锔 CONFIG DE TU PROYECTO
    const firebaseConfig = {
      apiKey: "AIzaSyCSNOqqsla1tab4laMk_yS7nQkC7yFEMDs",
      authDomain: "angelito-familia.firebaseapp.com",
      projectId: "angelito-familia",
      storageBucket: "angelito-familia.firebasestorage.app",
      messagingSenderId: "543102415608",
      appId: "1:543102415608:web:0e7ba86e3b29de9a87810d",
      measurementId: "G-7RN4FRE9SR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Analytics opcional
    isSupported()
      .then((ok) => {
        if (ok) getAnalytics(app);
      })
      .catch((err) => console.warn("Firebase analytics no disponible", err));

    //  Colecci贸n de participantes
    const participantsCol = collection(db, "participants");

    //  Buscar participante por c贸digo (EN MINSCULAS)
    async function getParticipantByCode(code) {
      const cleanCode = code.trim().toLowerCase();  //  cambio aqu铆
      const q = query(participantsCol, where("code", "==", cleanCode));
      const snap = await getDocs(q);

      if (snap.empty) return null;

      const docSnap = snap.docs[0];
      return { id: docSnap.id, ...docSnap.data() };
    }

    //  Obtener todos los participantes
    async function getAllParticipants() {
      const snap = await getDocs(participantsCol);
      return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
    }

    //  Escoger un angelito disponible (sin repetirse y que no seas t煤 mismo)
    async function pickAngelitoFor(participant) {
      const all = await getAllParticipants();

      const allNames = all.map((p) => p.name);
      const takenNames = new Set(
        all
          .map((p) => p.assignedTo)
          .filter((name) => !!name)
      );

      const available = allNames.filter(
        (name) => name !== participant.name && !takenNames.has(name)
      );

      if (!available.length) {
        throw new Error(
          "No hay angelitos disponibles. Revisa la configuraci贸n en Firestore."
        );
      }

      const randomIndex = Math.floor(Math.random() * available.length);
      return available[randomIndex];
    }

    //  Guardar en Firestore que ya escogi贸
    async function markPicked(participantId, assignedName) {
      const ref = doc(db, "participants", participantId);
      await updateDoc(ref, {
        hasPicked: true,
        assignedTo: assignedName,
        pickedAt: serverTimestamp()
      });
    }

    // -------------------------
    //  LGICA DE LA PGINA
    // -------------------------

    const form = document.getElementById("codeForm");
    const codeInput = document.getElementById("codeInput");
    const messageDiv = document.getElementById("message");
    const celebrationDiv = document.getElementById("celebration");
    const celebrationTitle = document.getElementById("celebrationTitle");

    const resetBtn = document.createElement("button");
    resetBtn.type = "button";
    resetBtn.className = "btn btn-outline-light btn-sm mt-2 d-none";
    resetBtn.textContent = "Inserta otro c贸digo";
    messageDiv.after(resetBtn);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      messageDiv.innerHTML = "";
      celebrationDiv.classList.add("d-none");
      resetBtn.classList.add("d-none");

      const rawCode = codeInput.value.trim();
      if (!rawCode) return;

      // Para Firebase usamos MINSCULAS
      const codeForDb = rawCode.toLowerCase();  //  cambio aqu铆

      try {
        // 1) Buscar participante por c贸digo
        const participant = await getParticipantByCode(codeForDb);

        if (!participant) {
          messageDiv.innerHTML = `
            <div class="alert alert-danger" role="alert">
              C贸digo no encontrado. Verifica que lo escribiste bien.
            </div>
          `;
          return;
        }

        if (participant.hasPicked) {
          messageDiv.innerHTML = `
            <div class="alert alert-warning" role="alert">
              Este c贸digo ya fue utilizado anteriormente.
            </div>
          `;
          return;
        }

        // 2) Escoger angelito disponible
        const angelitoName = await pickAngelitoFor(participant);

        // 3) Guardar en Firestore
        await markPicked(participant.id, angelitoName);

        // 4) Mostrar celebraci贸n
        celebrationTitle.textContent =
          " Felicidades, tu angelito es: " + angelitoName + " ";
        celebrationDiv.classList.remove("d-none");

        messageDiv.innerHTML = `
          <div class="alert alert-success" role="alert">
            Tu c贸digo ha sido usado y no podr谩 volver a participar.
          </div>
        `;

        codeInput.disabled = true;
        form.querySelector("button[type='submit']").disabled = true;
        resetBtn.classList.remove("d-none");
      } catch (error) {
        console.error(error);
        messageDiv.innerHTML = `
          <div class="alert alert-danger" role="alert">
            Ocurri贸 un error. Int茅ntalo de nuevo o contacta al organizador.
          </div>
        `;
      }
    });

    resetBtn.addEventListener("click", () => {
      codeInput.disabled = false;
      codeInput.value = "";
      form.querySelector("button[type='submit']").disabled = false;
      messageDiv.innerHTML = "";
      celebrationDiv.classList.add("d-none");
      resetBtn.classList.add("d-none");
      codeInput.focus();
    });

    // Normalizar visualmente a min煤sculas mientras escribe
    codeInput.addEventListener("input", () => {
      codeInput.value = codeInput.value.toLowerCase();
    });
  </script>
</body>
</html>